name: CI/CD Pipeline

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
    PNPM_VERSION: '8'

jobs:
    # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®å“è³ªãƒã‚§ãƒƒã‚¯
    pr-quality-check:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: 'package.json'
                  cache: 'pnpm'

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Setup environment variables
              run: |
                  echo "NODE_ENV=test" >> "$GITHUB_ENV"
                  echo "SKIP_ENV_VALIDATION=true" >> "$GITHUB_ENV"

            - name: Run comprehensive validation
              run: pnpm validate
              env:
                  NODE_ENV: test
                  SKIP_ENV_VALIDATION: true

            - name: Comment PR with results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v8
              with:
                  script: |
                      const { owner, repo } = context.repo;
                      const prNumber = context.payload.pull_request.number;

                      const comment = `
                      ## ğŸš€ CI/CD Results

                      âœ… **å“è³ªã‚²ãƒ¼ãƒˆ**: ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ
                      - ãƒªãƒ³ãƒˆ: âœ“
                      - å‹ãƒã‚§ãƒƒã‚¯: âœ“  
                      - ãƒ†ã‚¹ãƒˆ: âœ“
                      - ãƒ“ãƒ«ãƒ‰: âœ“

                      ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒãƒ¼ã‚¸æº–å‚™å®Œäº†ã§ã™ï¼
                      `;

                      await github.rest.issues.createComment({
                        owner,
                        repo,
                        issue_number: prNumber,
                        body: comment
                      });

    # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã®ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™
    deploy-preparation:
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        runs-on: ubuntu-latest
        timeout-minutes: 20

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: 'package.json'
                  cache: 'pnpm'

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Setup production environment
              run: |
                  echo "NODE_ENV=production" >> "$GITHUB_ENV"
                  echo "SKIP_ENV_VALIDATION=true" >> "$GITHUB_ENV"

            - name: Run full validation suite
              run: pnpm validate
              env:
                  NODE_ENV: production
                  SKIP_ENV_VALIDATION: true

            - name: Build for production
              run: pnpm build
              env:
                  NODE_ENV: production
                  SKIP_ENV_VALIDATION: true

            - name: Generate deployment artifacts
              run: |
                  # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®æº–å‚™
                  echo "ğŸ“¦ Building deployment artifacts..."
                  tar -czf build-artifacts.tar.gz .next/ package.json pnpm-lock.yaml

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts-${{ github.sha }}
                  path: build-artifacts.tar.gz
                  retention-days: 30

            - name: Deployment notification
              run: |
                  echo "ğŸš€ Deployment preparation completed!"
                  echo "Build artifacts are ready for Cloudflare Pages deployment"
                  echo "SHA: ${{ github.sha }}"
                  echo "Ref: ${{ github.ref }}"

    # ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ç”¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
    status-check:
        runs-on: ubuntu-latest
        needs: [pr-quality-check]
        if: always() && github.event_name == 'pull_request'

        steps:
            - name: Check overall status
              run: |
                  if [[ "${{ needs.pr-quality-check.result }}" == "success" ]]; then
                    echo "âœ… All checks passed - PR is ready to merge"
                    exit 0
                  else
                    echo "âŒ Some checks failed - PR needs attention"
                    exit 1
                  fi
